var casper=require("casper").create({pageSettings:{loadImages:!1,loadPlugins:!1},viewportSize:{width:1,height:1}}),fs=require("fs"),cfnProfile=casper.cli.raw.get("profile"),refreshInterval=casper.cli.raw.get("refreshinterval"),writeAJSON=casper.cli.raw.get("writejson"),jsonLocation=casper.cli.raw.get("jsonlocation"),modes=[{num:0,type:"rank",wins:0,losses:0,ratio:"0%"},{num:1,type:"casual",wins:0,losses:0,ratio:"0%"},{num:2,type:"lounge",wins:0,losses:0,ratio:"0%"}],updated=0,updateCount=[0,0,0],modeArr=[[],[],[]];function fetchStats(){var e=[0],t=[0];casper.waitForSelector("."+modes[2].type+" .win .on",function(){for(var s=0;s<modes.length;s++)e[s]=this.evaluate(function(e){return document.querySelector("."+e+" .win ul").innerHTML},modes[s].type),t[s]=e[s].split("</"),updateStats(t[s],modes[s]),reload()})}var rank=0,realLP=0,netLP=0,LPArray=[];function fetchRank(){casper.waitForSelector(".playerInfo>dl:last-child>dd",function(){casper.echo("\nAction: Fetching "+cfnProfile+"'s rank and LP"),rank=this.evaluate(function(e){return document.querySelector(e).innerText},".playerInfo>dl:last-child>dd");var e=this.evaluate(function(){return document.querySelector(".leagueInfo>dl:last-child>dd").innerText});realLP=parseInt(e,10),LPArray.push(realLP),LPArray.length>1&&LPArray[LPArray.length-1]!==LPArray[LPArray.length-2]&&(netLP=LPArray[LPArray.length-1]-LPArray[0])>0&&(netLP="+"+netLP),casper.echo("\n\trank: "+rank+"\t\tLP: "+realLP+"\t\tNet LP: "+netLP)})}function updateStats(e,t){for(var s=0;s<e.length;s++)e[s]!==modeArr[t.num][s]?(casper.echo("\nAction: Fetching "+cfnProfile+"'s "+t.type+" stats..."),-1!==e[19].indexOf("on")?t.wins++:t.losses++,0===updateCount[t.num]&&0===t.wins&&1===t.losses||1===t.wins&&0===t.losses?(t.wins=0,t.losses=0,updateCount[t.num]++):(t.losses>0||t.wins>0)&&(t.ratio=Math.floor(t.wins/(t.wins+t.losses)*100)+"%","rank"===t.type&&fetchRank()),modeArr[t.num]=e.slice(),casper.echo("\n\tWins: "+t.wins+"\t\t\tLosses: "+t.losses+"\t\tWin Ratio: "+t.ratio),writeTxt(t.type,t.wins,t.losses,t.ratio),"true"===writeAJSON&&writeJSON(0),updated=1):updated=0}function reload(){casper.wait(refreshInterval,function(){this.reload(function(){this.echo("\nRefreshing..."),fetchStats()})})}function writeTxt(e,t,s,r){fs.write(fs.pathJoin("result/"+e,"wins.txt"),t),fs.write(fs.pathJoin("result/"+e,"losses.txt"),s),fs.write(fs.pathJoin("result/"+e,"ratio.txt"),r),fs.write(fs.pathJoin("result/rank.txt"),rank),fs.write(fs.pathJoin("result/LP.txt"),realLP),fs.write(fs.pathJoin("result/netLP.txt"),netLP)}function writeJSON(e){var t,s=new Array;if(0===e)for(var r=0;r<modes.length;r++)s[r]='"'+modes[r].type+'":{"wins":'+modes[r].wins+',"losses":'+modes[r].losses+',"ratio":"'+modes[r].ratio+'"}';else for(r=0;r<modes.length;r++)s[r]='"'+modes[r].type+'":{"wins":0,losses":0,ratio":"0"}';t='{"account":{"rank":'+rank+',"lp":'+realLP+',"net":"'+netLP+'"},'+s[0]+", "+s[1]+", "+s[2]+"}";var n=new XMLHttpRequest;n.open("PUT",jsonLocation),n.setRequestHeader("Content-Type","application/json"),n.onload=function(){200===n.status&&n.responseText!==t?casper.echo("Something went wrong.  It is currently"+n.responseText):200!==n.status&&casper.echo("Request failed.  Returned status of "+n.status)},n.send(t)}function run(){casper.start("https://game.capcom.com/cfn/sfv/gate/steam?rpnt=https://game.capcom.com/cfn/sfv/profile/"+cfnProfile,function(){this.echo("Action: Accepting CFN Terms"),this.click('input[value="Agree"]')}),casper.waitForSelector("form input[name='username']",function(){this.fillSelectors("form#loginForm",{"input[name = username ]":casper.cli.raw.get("steamid"),"input[name = password ]":casper.cli.raw.get("steampass")},!0),this.click("input#imageLogin"),this.echo("Action: Logging in to "+this.getTitle()),this.wait(3e3)}),fetchRank(),fetchStats(),"true"===writeAJSON&&writeJSON(1),casper.run()}casper.options.onResourceRequested=function(e,t,s){["https://www.gstatic.com/charts/loader.js","https://www.gstatic.com/charts/46.1/loader.js","https://www.gstatic.com/charts/46.1/js/jsapi_compiled_corechart_module.js","https://www.gstatic.com/charts/46.1/js/jsapi_compiled_ui_module.js","https://www.gstatic.com/charts/46.1/js/jsapi_compiled_default_module.js","https://www.gstatic.com/charts/46.1/js/jsapi_compiled_format_module.js"].forEach(function(e){t.url.indexOf(e)>0&&s.abort()})},refreshInterval<5e3||null===refreshInterval||null===cfnProfile?(casper.echo("Your settings are misconfigured"),casper.exit()):run();
