var casper=require("casper").create({pageSettings:{loadImages:!1,loadPlugins:!1},viewportSize:{width:1,height:1}}),fs=require("fs"),cfn=casper.cli.raw.get("profile"),refreshInterval=casper.cli.raw.get("refreshinterval"),writeAJSON=casper.cli.raw.get("writejson"),jsonLoc=casper.cli.raw.get("jsonlocation"),modes=[{num:0,type:"rank",wins:0,losses:0,ratio:"0%"},{num:1,type:"casual",wins:0,losses:0,ratio:"0%"},{num:2,type:"lounge",wins:0,losses:0,ratio:"0%"}],updated=0,updateCount=[0,0,0],modeArr=[[],[],[]];function fetchStats(){var e=[0],t=[0];casper.waitForSelector("."+modes[2].type+" .win .on",function(){for(var r=0;r<modes.length;r++)e[r]=this.evaluate(function(e){return document.querySelector("."+e+" .win ul").innerHTML},modes[r].type),t[r]=e[r].split("</"),updateStats(t[r],modes[r]),reload()})}var myRank=0,myLP=0,netLP=0,LPArray=[];function fetchRank(){casper.waitForSelector(".playerInfo>dl:last-child>dd",function(){myRank=this.evaluate(function(e){return document.querySelector(e).innerText},".playerInfo>dl:last-child>dd");var e=this.evaluate(function(){return document.querySelector(".leagueInfo>dl:last-child>dd").innerText});myLP=parseInt(e,10),LPArray.push(myLP),LPArray.length>1&&LPArray[LPArray.length-1]!==LPArray[LPArray.length-2]&&(netLP=LPArray[LPArray.length-1]-LPArray[0])>0&&(netLP="+"+netLP),this.echo("\n\trank: "+myRank+"\t\tLP: "+myLP+" ("+getLeague(myLP)+")\tNet LP: "+netLP)})}function updateStats(e,t){for(var r=0;r<e.length;r++)if(e[r]!==modeArr[t.num][r]){var s=new Date,n=s.getHours()+":"+s.getMinutes();if(-1!==e[19].indexOf("on")?t.wins++:t.losses++,0===updateCount[t.num]&&(0===t.wins&&1===t.losses||1===t.wins&&0===t.losses))t.wins=0,t.losses=0;else if(t.losses>0||t.wins>0){t.ratio=Math.floor(t.wins/(t.wins+t.losses)*100)+"%";var a="\r\n("+n+") "+t.type+" match #"+updateCount[t.num],o="\r\n\tWins: "+t.wins+"\t\t\tLosses: "+t.losses+"\t\t\tWin Ratio: "+t.ratio,i="Wins: "+t.wins+", Losses: "+t.losses+", Win Ratio: "+t.ratio;casper.echo(a),writeLog("\t"+a+"\t"+i+"\t"),"rank"===t.type?(fetchVersus(),fetchRank(),casper.wait(500,function(){this.echo(o)})):casper.echo(o)}modeArr[t.num]=e.slice(),writeTxt(t.type,t.wins,t.losses,t.ratio),"true"===writeAJSON&&writeJSON(0),updated=1,updateCount[t.num]++}else updated=0}function fetchVersus(){casper.waitForSelector(".recentbox .fighter",function(){var e=this.evaluate(function(){return document.querySelectorAll(".recentbox>.fId>dd")[0].innerText}),t=this.evaluate(function(){return document.querySelectorAll(".recentbox>.league>dd")[0].innerText}),r=this.evaluate(function(){return document.querySelectorAll(".recentbox>.fav>dd")[0].innerText}),s=this.evaluate(function(){return document.querySelectorAll(".leagueWrap dl>dd>a")[0].innerText}),n=cfn+" ("+globalizeChar(s)+") ("+getLeague(myLP)+") vs. "+e+" ("+globalizeChar(r)+") ("+getLeague(t)+")";this.echo("\t"+n),writeLog("\n"+n)})}function globalizeChar(e){return"VEGA"===e?"Boxer":"M. BISON"===e?"Claw":"BALROG"===e?"Dictator":e.charAt(0)+e.slice(1).toLowerCase()}function getLeague(e){var t="";return e>=3e5?t="Warlord":e>=1e5?t="Ultimate Grand Master":e>=35e3?t="Grand Master":e>=3e4?t="Master":e>=25e3?t="Ultra Diamond":e>=2e4?t="Super Diamond":e>=14e3?t="Diamond":e>=12e3?t="Ultra Platinum":e>=1e4?t="Super Platinum":e>=7500?t="Platinum":e>=6500?t="Ultra Gold":e>=4500?t="Super Gold":e>=4e3?t="Gold":e>=3500?t="Ultra Silver":e>=3e3?t="Super Silver":e>=2e3?t="Silver":e>=1500?t="Ultra Bronze":e>=1e3?t="Super Bronze":e>=500?t="Bronze":e<500&&(t="Rookie"),t}function reload(){casper.wait(refreshInterval,function(){this.reload(function(){fetchStats()})})}function writeTxt(e,t,r,s){fs.write(fs.pathJoin("result/"+e,"wins.txt"),t),fs.write(fs.pathJoin("result/"+e,"losses.txt"),r),fs.write(fs.pathJoin("result/"+e,"ratio.txt"),s),fs.write(fs.pathJoin("result/rank.txt"),myRank),fs.write(fs.pathJoin("result/LP.txt"),myLP),fs.write(fs.pathJoin("result/netLP.txt"),netLP)}function writeLog(e){fs.write("LOGFiLE.log",e,"a")}function writeJSON(e){var t,r=[];if(0===e)for(var s=0;s<modes.length;s++)r[s]='"'+modes[s].type+'":{"wins":'+modes[s].wins+',"losses":'+modes[s].losses+',"ratio":"'+modes[s].ratio+'"}';else for(s=0;s<modes.length;s++)r[s]='"'+modes[s].type+'":{"wins":0,losses":0,ratio":"0"}';t='{"account":{"rank":'+myRank+',"lp":'+myLP+',"net":"'+netLP+'"},'+r[0]+", "+r[1]+", "+r[2]+"}";var n=new XMLHttpRequest;n.open("PUT",jsonLoc),n.setRequestHeader("Content-Type","application/json"),n.onload=function(){200===n.status&&n.responseText!==t?casper.echo("Something went wrong.  It is currently"+n.responseText):200!==n.status&&casper.echo("Request failed.  Returned status of "+n.status)},n.send(t)}function run(){var e=new Date,t=e.getFullYear()+"-"+(e.getMonth()+1)+"-"+e.getDate();casper.echo(t),writeLog(t),casper.start("https://game.capcom.com/cfn/sfv/gate/steam?rpnt=https://game.capcom.com/cfn/sfv/profile/"+cfn,function(){this.echo("Action: Accepting CFN Terms"),this.click('input[value="Agree"]')}),casper.waitForSelector("form input[name='username']",function(){this.echo("Action: Logging in to "+this.getTitle()),this.fillSelectors("form#loginForm",{"input[name = username ]":casper.cli.raw.get("steamid"),"input[name = password ]":casper.cli.raw.get("steampass")},!0),this.click("input#imageLogin"),this.echo("Success"),this.wait(3e3)}),fetchRank(),fetchStats(),"true"===writeAJSON&&writeJSON(1),casper.run()}casper.options.onResourceRequested=function(e,t,r){["https://www.gstatic.com/charts/loader.js","https://www.gstatic.com/charts/46.1/loader.js","https://www.gstatic.com/charts/46.1/js/jsapi_compiled_corechart_module.js","https://www.gstatic.com/charts/46.1/js/jsapi_compiled_ui_module.js","https://www.gstatic.com/charts/46.1/js/jsapi_compiled_default_module.js","https://www.gstatic.com/charts/46.1/js/jsapi_compiled_format_module.js"].forEach(function(e){t.url.indexOf(e)>0&&r.abort()})},refreshInterval<5e3||null===refreshInterval||null===cfn?(casper.echo("Your settings are misconfigured"),casper.exit()):run();